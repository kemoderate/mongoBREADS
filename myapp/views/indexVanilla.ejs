<!DOCTYPE html>
<html>

<head>
    <title>
    </title>
    <link rel='stylesheet' href='/stylesheets/style.css' />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/6ea2cb925f.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <style>
        .sort-icon {
            margin-left: 5px;
        }

        .sort-icon.asc:before {
            content: "\f0de";
        }

        .sort-icon.desc:before {
            content: "\f0dd";
        }

        .show-edit-form {
            display: block;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>BREADS (Browse, Read, Update, Delete, Sort)</h1>
        <h4>Fillters</h4>
        <form id="filter-form">
            <input type="hidden" name="page" value="1">
            <div class="row mb-3">
                <label for="inputId" class="col-sm-4 col-form-label">
                    <input type="checkbox" name="checkId" id="checkId">
                    ID
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="idFilter" name="id">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputStr" class="col-sm-4 col-form-label">
                    <input type="checkbox" name="checkStr" id="checkStr">
                    String
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="strFilter" name="string">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputInt" class="col-sm-4 col-form-label">
                    <input type="checkbox" name="checkInt" id="checkInt">
                    Integer
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="intFilter" name="integer">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputFloat" class="col-sm-4 col-form-label">
                    <input type="checkbox" name="checkFloat" id="checkFloat">
                    Float
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="floatFilter" name="float">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputDate" class="col-sm-4 col-form-label">
                    <input type="checkbox" name="checkDate" id="checkDate">
                    Date
                </label>
                <div class="col-sm-4">
                    <input type="date" class="form-control" id="startDateFilter" name="startDate">
                    to
                    <input type="date" class="form-control" id="endDateFilter" name="endDate">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputBol" class="col-sm-4 col-form-label">
                    <input type="checkbox" name="checkBol" id="checkBol">
                    Boolean
                </label>
                <div class="col-sm-8">
                    <select name="boolean" id="booleanFilter" class="form-select">
                        <option>Choose the boolean</option>
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Search</button>
            <a href="/" class="btn btn-secondary">Reset</a>
        </form>
        <br>
        <form id="create-form" style="display: none;">
            <div class="row mb-3">
                <label for="inputId" class="col-sm-4 col-form-label">
                    ID
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="id" name="id">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputStr" class="col-sm-4 col-form-label">
                    String
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="string" name="string">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputInt" class="col-sm-4 col-form-label">
                    Integer
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="integer" name="integer">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputFloat" class="col-sm-4 col-form-label">
                    Float
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="float" name="float">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputDate" class="col-sm-4 col-form-label">
                    Date
                </label>
                <div class="col-sm-4">
                    <input type="date" class="form-control" id="startDate" name="startDate">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputBol" class="col-sm-4 col-form-label">
                    Boolean
                </label>
                <div class="col-sm-8">
                    <select name="boolean" id="boolean" class="form-select">
                        <option>Choose the boolean</option>
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>
                </div>
            </div>
            <!-- <button class="btn btn-primary">Search</button> -->
            <button type="submit" class="btn btn-primary">Save</button>
            <a onclick="closeAdd()" class="btn btn-secondary">Close</a>
        </form>
        <br>
        <form id="edit-form" style="display: none;">
            <div class="row mb-3">
                <label for="inputId" class="col-sm-4 col-form-label">
                    ID
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="id2" name="id">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputStr" class="col-sm-4 col-form-label">
                    String
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="string2" name="string">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputInt" class="col-sm-4 col-form-label">
                    Integer
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="integer2" name="integer">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputFloat" class="col-sm-4 col-form-label">
                    Float
                </label>
                <div class="col-sm-8">
                    <input type="text" class="form-control" id="float2" name="float">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputDate" class="col-sm-4 col-form-label">
                    Date
                </label>
                <div class="col-sm-4">
                    <input type="date" class="form-control" id="startDate2" name="startDate">
                </div>
            </div>
            <div class="row mb-3">
                <label for="inputBol" class="col-sm-4 col-form-label">
                    Boolean
                </label>
                <div class="col-sm-8">
                    <select name="boolean" id="boolean2" class="form-select">
                        <option>Choose the boolean</option>
                        <option value="true">True</option>
                        <option value="false">False</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-info">Save</button>
            <a onclick="closeEdit()" class="btn btn-secondary">Close</a>
        </form>
    </div>
    <br>
    <div class="container">
        <table class="table table-striped table-bordered">
            <thead id="data-head">
            </thead>
            <tbody id="data-body">
            </tbody>
        </table>
        <nav aria-label="Page navigation example">
            <ul class="pagination" id="pagination" style="cursor: pointer;">

            </ul>
        </nav>
        <button type="submit" onclick="showAdd()" class="btn btn-primary">Add</button>
        <br>
    </div>

    <script type="text/javascript">
        let params = {
            page: 1,
            sortBy: '',
            sortOrder: ''
        };
        document.getElementById('create-form').addEventListener("submit", function (event) {
            event.preventDefault();
            const number = document.getElementById('id').value;
            const string = document.getElementById('string').value;
            const integer = document.getElementById('integer').value;
            const float = document.getElementById('float').value;
            const date = document.getElementById('startDate').value;
            const boolean = document.getElementById('boolean').value;
            createData(number, string, integer, float, date, boolean);
        });

        document.getElementById('filter-form').addEventListener("submit", function (event) {
            event.preventDefault();
            params.page = 1; // Reset page to 1 when applying new filters
            readData(getFilterParams());
        })
        function getFilterParams() {
            const filterParams = {};

            if (document.getElementById('checkId').checked) {
                filterParams.checkId = true;
                filterParams.id = document.getElementById('idFilter').value;
            }

            if (document.getElementById('checkStr').checked) {
                filterParams.checkStr = true;
                filterParams.string = document.getElementById('strFilter').value;
            }

            if (document.getElementById('checkInt').checked) {
                filterParams.checkInt = true;
                filterParams.integer = document.getElementById('intFilter').value;
            }

            if (document.getElementById('checkFloat').checked) {
                filterParams.checkFloat = true;
                filterParams.float = document.getElementById('floatFilter').value;
            }

            if (document.getElementById('checkDate').checked) {
                filterParams.checkDate = true;
                filterParams.startDate = document.getElementById('startDateFilter').value;
                filterParams.endDate = document.getElementById('endDateFilter').value;
            }

            if (document.getElementById('checkBol').checked) {
                filterParams.checkBol = true;
                filterParams.boolean = document.getElementById('booleanFilter').value;
            }

            return filterParams;
        }

        async function readData(filterParams) {
            try {
                const mergedParams = { ...params, ...filterParams };
                const queryString = Object.keys(mergedParams)
                    .filter((key) => mergedParams[key] !== '')
                    .map((key) => `${key}=${mergedParams[key]}`)
                    .join('&');

                const url = `http://localhost:3000/data?${queryString}`;

                const response = await fetch(url);

                if (response.ok) {
                    const { data, page, pages, query, sortby, sortorder } = await response.json();
                    params.page = page;
                    displayData(data, sortby, sortorder);
                    pagination(page, pages);
                    sortData(sortby, sortorder);
                } else {
                    throw new Error("Error: " + response.status);
                }
            } catch (error) {
                console.log(error);
                // Handle error, display a message
            }
        }
        async function createData(number, string, integer, float, date, boolean) {
            try {
                const data = {
                    number: number,
                    string: string,
                    integer: integer,
                    float: float,
                    date: date,
                    boolean: boolean
                };

                // Check if any field is empty
                if (!number || !string || !integer || !float || !date || !boolean) {
                    alert('Please,Insert the data')
                    return
                }
                const response = await fetch('http://localhost:3000/data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log("Success:", result);
                    // Clear input fields
                    document.getElementById('id').value = '';
                    document.getElementById('string').value = '';
                    document.getElementById('integer').value = '';
                    document.getElementById('float').value = '';
                    document.getElementById('startDate').value = '';
                    document.getElementById('boolean').value = '';
                    readData(); // Refresh data after successful creation
                } else {
                    console.error('Error creating data:', response.status);
                }
            } catch (error) {
                console.log(error);
            }
        }
        async function updateData(event,id3) {
            event.preventDefault(); // Prevent the form from submitting

            // Retrieve the values from the form fields
            const number = document.getElementById('id2').value;
            const string = document.getElementById('string2').value;
            const integer = document.getElementById('integer2').value;
            const float = document.getElementById('float2').value;
            const date = document.getElementById('startDate2').value;
            const boolean = document.getElementById('boolean2').value;

            // Make an API request to update the data
            try {
                const response = await fetch(`http://localhost:3000/data/${id3}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        number,
                        string,
                        integer,
                        float,
                        date,
                        boolean : boolean,
                    }),
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log("Success:", result);
                    closeEdit(); // Close the edit form
                    readData(); // Refresh data after successful update
                } else {
                    console.error('Error updating data:', response.status);
                }
            } catch (error) {
                console.log(error);
            }
        }

        async function deleteData(id) {
            try {
                const response = await fetch(`http://localhost:3000/data/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id })
                });

                if (response.ok) {
                    const result = await response.json();
                    // Handle the created data
                    console.log("Success:", result);
                    readData()
                } else {
                    throw new Error('Error: ' + response.status);
                }
            } catch (error) {
                console.log(error);
            }
        }
        let id3;
        function displayData(data, sortby, sortorder) {
            let html = "";
            data.forEach((item, index) => {
                html += `
        <tr>
            <td>${item.number}</td>
            <td>${item.string}</td>
            <td>${item.integer}</td>
            <td>${item.float}</td>
            <td>${item.date}</td>
            <td>${item.boolean}</td>
            <td>
                <button class="btn btn-success btn-sm" onclick="showEdit('${item._id}')">Edit</button>
                <button class="btn btn-danger btn-sm" onclick="deleteData('${item._id}')">Hapus</button>
            </td>
        </tr>`
        id3 = item._id;
            });
            document.getElementById('data-body').innerHTML = html;
        }
        function sortData(sortby, sortorder) {
            let html = `
                <tr align="center">
                    <th>
                        ID
                        <a href="javascript:void(0)" onclick="changeSort('number', '${sortby == 'number' && sortorder == 'asc' ? 'desc' : 'asc'}')">
                            <span class="fa ${sortby === 'number' ? (sortorder === 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"></span>
                        </a>
                    </th>
                    <th>

                        String
                        <a href="javascript:void(0)" onclick="changeSort('string', '${sortby == 'string' && sortorder == 'asc' ? 'desc' : 'asc'}')">
                            <span class="fa ${sortby === 'string' ? (sortorder === 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"></span>
                        </a>
                    </th>
                    <th>
                        Integer
                        <a href="javascript:void(0)" onclick="changeSort('integer', '${sortby == 'integer' && sortorder == 'asc' ? 'desc' : 'asc'}')">
                            <span class="fa ${sortby === 'integer' ? (sortorder === 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"></span>
                        </a>
                    </th>
                    <th>
                        Float
                        <a href="javascript:void(0)" onclick="changeSort('float', '${sortby == 'float' && sortorder == 'asc' ? 'desc' : 'asc'}')">
                            <span class="fa ${sortby === 'float' ? (sortorder === 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"></span>
                        </a>
                    </th>
                    <th>
                        Date
                        <a href="javascript:void(0)" onclick="changeSort('date', '${sortby == 'date' && sortorder == 'asc' ? 'desc' : 'asc'}')">
                            <span class="fa ${sortby === 'date' ? (sortorder === 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"></span>
                        </a>
                    </th>
                    <th>
                        Boolean
                        <a href="javascript:void(0)" onclick="changeSort('boolean', '${sortby == 'boolean' && sortorder == 'asc' ? 'desc' : 'asc'}')">
                            <span class="fa ${sortby === 'boolean' ? (sortorder === 'asc' ? 'fa-sort-up' : 'fa-sort-down') : 'fa-sort'}"></span>
                        </a>
                    </th>
                    <th>Action</th>
                </tr>
                `
            document.getElementById('data-head').innerHTML = html
        }
        function pagination(currentPage, totalPages) {
            let html = `
                <li class="page-item ${params.page == 1 ? 'disabled' : ''}">
                    <a class="page-link" onclick="changePage(${currentPage - 1})">Previous</a>
                </li>`;

            for (let page = 1; page <= totalPages; page++) {
                html += `
                <li class="page-item ${page === currentPage ? 'active' : ''} ">
                    <a class="page-link" onclick="changePage(${page})">${page}</a>
                </li>`;
            }

            html += `
                <li class="page-item ${params.page == totalPages ? 'disabled' : ''}">
                    <a class="page-link"  onclick="changePage(${currentPage + 1})">Next</a>
                </li>`;

            document.getElementById('pagination').innerHTML = html;
        }
        function changePage(page) {
            console.log('Page:', page);
            params.page = page;
            // error handle for default pagination to see if the data still not sorted, the pagination still works
            if (params.sortby) {
                readData({ sortby: params.sortby, ...getFilterParams(), sortorder: params.sortorder, page: page });
            } else {
                readData({ ...getFilterParams(), page: page });
            }
        }
        function changeSort(sortby, sortorder) {
            console.log(`SortBy: ${sortby}, SortOrder: ${sortorder}`);
            params.sortby = sortby; // Update sortby parameter in params
            params.sortorder = sortorder; // Update sortorder parameter in params
            readData({ sortby, sortorder, ...getFilterParams(), page: params.page }); // Pass sorting parameters and current page
        }

        function showAdd() {
            document.getElementById("create-form").style.display = 'block'
        }
        function closeAdd() {
            document.getElementById("create-form").style.display = 'none'
        }
        async function showEdit(id) {
            if (id === undefined) {
                console.error('Error: ID is undefined');
                return;
            }
            const form = document.getElementById("edit-form");
            try {
                const response = await fetch(`http://localhost:3000/data/edit/${id}`)
                const data = await response.json();
                form.querySelector("#id2").value = data[0].number;
                form.querySelector("#string2").value = data[0].string;
                form.querySelector("#integer2").value = data[0].integer;
                form.querySelector("#float2").value = data[0].float;
                form.querySelector("#startDate2").value = moment(new Date(data[0].date)).format('YYYY-MM-DD');
                form.querySelector("#boolean2").value = data[0].boolean
            } catch (error) {
                console.log('Error : ', error)
            }
            form.style.display = 'block';
        }
        function closeEdit() {
            document.getElementById("edit-form").style.display = 'none'
        }
        document
        .getElementById("edit-form")
        .addEventListener("submit", function (event) {
          event.preventDefault();
         
          updateData(event,id3);
        });
        readData(params);
    </script>
</body>

</html>